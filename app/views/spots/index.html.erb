<div class="container">
  <div class="row">
    <div class="col-12 my-5 d-flex justify-content-center">
      <h2><i class="fas fa-map-marked-alt"></i>現在地から探す</h2>
    </div>
    <div id="map" class="mt-5 mx-auto"></div>
  </div>
</div>

<script>
  let map, geocoder, storemarker = [], infoWindow = [];
  const stores = gon.stores;

  function initMap(){
    geocoder = new google.maps.Geocoder()
    if(!navigator.geolocation) {
      alert('Geolocation APIに対応していません');
      return false;
    }
    // 現在地が取得できたら地図の中心にピンを立てて表示、取得に失敗したらアラートを表示
    navigator.geolocation.getCurrentPosition(function(position) {
      latLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

      map = new google.maps.Map(document.getElementById('map'), {
        center: latLng,
        zoom: 12,
      });

      marker = new google.maps.Marker({
        position:  latLng,
        map: map
      });

      for (let i = 0; i < stores.length; i++){
      storemarker[i] = new google.maps.Marker({
        map: map,
        position: {
          lat: stores[i].latitude,
          lng: stores[i].longitude
        }
      });

      storeId = stores[i].id

      contentString =
        `<p class="mb-0">施設名：<a href='/stores/${storeId}'>${stores[i].name}</a></p>` +
        '<hr class="my-0">' +
        `<p class="mt-3 mb-0">施設紹介:${stores[i].introduction}</p>` +
        `<p class="mt-1 mb-0">住所　　:${stores[i].prefecture_code}${stores[i].city}</p>`;

      infoWindow[i] = new google.maps.InfoWindow({
        content: contentString
      });
      storemarker[i].addListener("click", () => {
        infoWindow[i].open(map, storemarker[i]);
      });
    }
    }, function() {
        alert('位置情報取得に失敗しました！位置情報へのアクセスが許可されているか確認してください');
      });
  }
</script>

<script async defer
      src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=<%= Rails.application.credentials.g_map[:api] %>&callback=initMap">
</script>
